<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shop Billing & Ledger System</title>
<style>
    body {
        margin: 0;
        padding: 0;
        background: #eef3ff;
        font-family: "Poppins", sans-serif;
        color: #102043;
    }

    .container {
        max-width: 950px;
        margin: 25px auto;
        padding: 20px;
    }

    h1, h2 {
        text-align: center;
        color: #102043;
        font-weight: 600;
        margin-bottom: 15px;
    }

    /* Navigation Buttons */
    #mainNav {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
    }

    .nav-button {
        display: block;
        text-align: center;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        background: #2962ff;
        border-radius: 10px;
        text-decoration: none;
        transition: 0.2s;
    }

    .nav-button:hover {
        background: #0039cb;
    }

    /* Sections Box */
    .section-box {
        background: #ffffff;
        padding: 20px;
        border-radius: 15px;
        margin-top: 25px;
        border: 1px solid #dde3f0;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.08);
    }

    label {
        display: block;
        font-weight: 500;
        margin-top: 12px;
        color: #132a4f;
    }

    input, select {
        width: 100%;
        padding: 12px;
        border: 1px solid #c7d3ea;
        border-radius: 8px;
        margin-top: 6px;
        background: #f8faff;
        font-size: 15px;
    }

    input:focus, select:focus {
        border-color: #2962ff;
        box-shadow: 0px 0px 5px rgba(41,98,255,0.4);
        outline: none;
    }

    input[type="radio"] {
        width: auto;
        margin-right: 5px;
        transform: scale(1.2);
    }

    /* Submit Button */
    .main-button {
        width: 100%;
        padding: 14px;
        background: #009688;
        color: white;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        margin-top: 18px;
        cursor: pointer;
        font-size: 17px;
        transition: 0.2s;
    }

    .main-button:hover {
        background: #006e5f;
    }

    /* Tables */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 18px;
        border: 1px solid #e1e7f3;
        background: white;
        border-radius: 10px;
        overflow: hidden;
    }

    th, td {
        padding: 12px;
        border-bottom: 1px solid #eef2fb;
        font-size: 15px;
        color: #102043;
    }

    th {
        background: #e6ecff;
        color: #142b5e;
        font-weight: 600;
    }

    tr:hover {
        background: #f2f5ff;
    }

    /* Colors for Attendance Status */
    .present-status {
        color: #0ea400;
        font-weight: 700;
    }

    .absent-status {
        color: #d30000;
        font-weight: 700;
    }

    .not-entered-status {
        color: #ff9d00;
        font-weight: 700;
    }

    /* Salary Highlight */
    .salary-amount {
        font-size: 19px;
        color: #0047d4;
        font-weight: 700;
    }
    /* STATUS COLORS */
.status-full-paid {
    color: #0ea400;
    font-weight: 700;
}

.status-partial {
    color: #ff8c00;
    font-weight: 700;
}

.status-pending {
    color: #d30000;
    font-weight: 700;
}

/* Action Buttons */
.action-button, .history-button, .delete-button, .unpaid-button {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    margin-right: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: white;
}

.action-button {
    background: #2962ff;
}
.action-button:hover {
    background: #0039cb;
}

.history-button {
    background: #6a1b9a;
}
.history-button:hover {
    background: #4a1370;
}

.delete-button {
    background: #d32f2f;
}
.delete-button:hover {
    background: #9a0007;
}

.unpaid-button {
    background: #ff9800;
}
.unpaid-button:hover {
    background: #e68900;
}

/* Header Controls */
.table-header-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
</style>
</head>
<body>

    <div class="container">
        <h1>üí∞ Shop Billing & Ledger System</h1>
        
        <div id="mainNav">
            <a href="wallet.html.html" class="nav-button" style="background-color: #28a745;">üí∞ Shop Billing (Current)</a>
            <a href="employee.html" class="nav-button">üíµ Salary System</a>
        </div>
        
        <div id="weeklySummary" class="section-box">
            <div class="table-header-controls">
                <h2>üìÖ Weekly Received Amount Summary</h2>
                <button onclick="clearAllData()" class="delete-button">
                    ‚ö†Ô∏è Clear ALL Data
                </button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end;">
                <div style="flex-grow: 1;">
                    <label for="startDateInput" style="margin-top: 0;">Start Date:</label>
                    <input type="date" id="startDateInput">
                </div>
                <div style="flex-grow: 1;">
                    <label for="endDateInput" style="margin-top: 0;">End Date:</label>
                    <input type="date" id="endDateInput">
                </div>
                <button onclick="calculateWeeklyEarnings(true)" class="action-button" style="padding: 10px 15px; height: 44px; margin-top: 5px; background: #009688;">Apply</button>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <p style="font-size: 1.1em; font-weight: 500;">Date Range: <span id="weekDates"></span></p>
                <p style="margin: 0; color: #102043; font-weight: 600;">Total Received:</p>
                <span class="salary-amount" id="totalWeeklyEarnings" style="font-size: 2.8em; display: inline-block; margin-top: 5px; color: #009688;">0.00</span> 
                <span style="font-size: 1.5em; color: #102043; font-weight: 600;">PKR</span>
            </div>
        </div>

        <div class="section-box" id="billEntrySection">
            <h2>üìù Enter New Bill</h2>
            <form id="billEntryForm">
                <label for="customerName">Customer Name:</label>
                <input type="text" id="customerName" required>

                <label for="refNumber">Reference Number (Unique):</label>
                <input type="text" id="refNumber" required>

                <label for="billNote">**Bill Note/Description (Will show in History):**</label>
                <input type="text" id="billNote">

                <label for="totalAmount">**Total Bill Amount (PKR):**</label>
                <input type="number" id="totalAmount" step="0.01" min="0" required>
                
                <label for="paidAmount">**Initial Paid Amount (PKR):**</label>
                <input type="number" id="paidAmount" step="0.01" min="0" value="0" required>

                <label for="billDate">Date:</label>
                <input type="date" id="billDate" value="<?= date('Y-m-d') ?>" required>
                
                <button type="submit" class="main-button">Save Bill</button>
                <p id="message" style="font-weight: bold; margin-top: 15px;"></p>
            </form>
        </div>

        <div class="section-box">
            <div class="table-header-controls">
                <h2>üîç Search Bills</h2>
                <button onclick="viewUnpaidBills()" class="unpaid-button">
                    ‚ö†Ô∏è View All Pending Bills
                </button>
            </div>
            
            <input type="text" id="searchQuery" placeholder="Enter Ref Number or Name">
            <button onclick="performSearch()" class="main-button" style="background: #2962ff;">Search</button>
            
            <table id="searchResultsTable">
                <thead>
                    <tr>
                        <th>Ref No.</th>
                        <th>Customer Name</th>
                        <th>Total</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="searchResultsBody">
                    </tbody>
            </table>
        </div>

        <div class="section-box">
            <div class="table-header-controls">
                <h2>üìã All Bills Record</h2>
                <button onclick="deleteAllFullyPaidBills()" class="delete-button">
                    ‚úÖ Delete Fully Paid Bills
                </button>
            </div>
            <table id="allBillsTable">
                <thead>
                    <tr>
                        <th>Ref No.</th>
                        <th>Customer Name</th>
                        <th>Total</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="allBillsBody">
                    </tbody>
            </table>
        </div>
        </div>

    <script>
        const STORAGE_KEY = 'shop_bills';
        
        // 1. Data Retrieval and Saving Functions
        function getBills() {
            const data = localStorage.getItem(STORAGE_KEY);
            let bills = data ? JSON.parse(data) : [];
            return bills.sort((a, b) => b.id - a.id);  
        }

        function saveBills(bills) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bills));
        }

        // Helper function to determine payment status
        function getPaymentStatus(total, paid) {
            const balance = total - paid;
            if (balance <= 0.005) {  
                return { text: 'Fully Paid', class: 'status-full-paid' };
            } else if (paid > 0) {
                return { text: 'Partial Paid', class: 'status-partial' };
            } else {
                return { text: 'Pending', class: 'status-pending' };
            }
        }

        // Helper function to display bills in a table
        function displayBills(bills, tableBodyId) {
            const resultsBody = document.getElementById(tableBodyId);
            resultsBody.innerHTML = ''; 

            if (bills.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="8" style="color: red;">No bills found.</td></tr>';
                return;
            }

            bills.forEach(bill => {
                const total = parseFloat(bill.totalAmount);
                const paid = parseFloat(bill.paidAmount);
                const balance = (total - paid);
                const status = getPaymentStatus(total, paid);
                
                const row = resultsBody.insertRow();
                row.insertCell().textContent = bill.refNumber;
                row.insertCell().textContent = bill.name;
                row.insertCell().textContent = total.toFixed(2);
                row.insertCell().textContent = paid.toFixed(2);
                
                const balanceCell = row.insertCell();
                balanceCell.textContent = balance.toFixed(2);
                
                row.insertCell().textContent = bill.date;
                
                // Status Cell
                const statusCell = row.insertCell();
                statusCell.textContent = status.text;
                statusCell.className = status.class;
                
                // Action Cell
                const actionCell = row.insertCell();
                
                // 1. Add Payment Button (Only if balance > 0)
                if (balance > 0.005) {  
                    const addButton = document.createElement('button');
                    addButton.textContent = 'Add Payment'; 
                    addButton.className = 'action-button';
                    addButton.onclick = () => addPayment(bill.id, total, paid); 
                    actionCell.appendChild(addButton);
                }
                
                // 2. History Button (Passing the new billNote)
                if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                    const historyButton = document.createElement('button');
                    historyButton.textContent = 'History';
                    historyButton.className = 'history-button';
                    historyButton.onclick = () => showPaymentHistory(bill.refNumber, bill.paymentHistory, bill.name, bill.billNote);
                    actionCell.appendChild(historyButton);
                }
                
                // 3. Delete Single Bill Button
                const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => deleteBill(bill.id, bill.refNumber);
                    actionCell.appendChild(deleteButton);
            });
        }
        
        // 2. MODIFIED FUNCTION: Show Payment History (Now displays Bill Note)
        function showPaymentHistory(refNumber, history, customerName, billNote) {
            let historyText = `--- Payment History for Bill ${refNumber} (${customerName}) ---\n\n`;
            
            // Displaying the Bill Note first
            historyText += `**BILL NOTE:** ${billNote || 'No Note Provided'}\n`;
            historyText += `-----------------------------------\n`;
            
            if (history.length === 0) {
                 historyText += "No payment history recorded yet.";
            } else {
                history.forEach(item => {
                    historyText += `Date: ${item.date}\nAmount: ${parseFloat(item.amount).toFixed(2)} PKR\n---\n`;
                });
            }
            
            alert(historyText);
        }
        
        // 3. View Only Unpaid Bills
        function viewUnpaidBills() {
            const bills = getBills();
            const unpaidBills = bills.filter(bill => (parseFloat(bill.totalAmount) - parseFloat(bill.paidAmount)) > 0.005);
            
            displayBills(unpaidBills, 'searchResultsBody');
            
            document.getElementById('searchQuery').value = '';
            
            if (unpaidBills.length > 0) {
                 alert(`Successfully showed ${unpaidBills.length} pending bills in the search results.`);
            } else {
                 alert("No pending bills found. Everything is clear!");
            }
        }
        
        // 4. Delete Single Bill 
        function deleteBill(billId, refNumber) {
            if (confirm(`Are you sure you want to delete Bill Number ${refNumber}? This action cannot be undone.`)) {
                let bills = getBills();
                const updatedBills = bills.filter(bill => bill.id !== billId);
                
                saveBills(updatedBills);
                calculateWeeklyEarnings();
                loadAllBills();
                document.getElementById('searchResultsBody').innerHTML = '';
                
                alert(`Bill ${refNumber} successfully deleted.`);
            }
        }
        
        // 5. Delete ALL Fully Paid Bills 
        function deleteAllFullyPaidBills() {
            if (!confirm("Are you sure you want to delete ALL 'Fully Paid' bills? This action cannot be undone.")) {
                return;
            }

            let bills = getBills();
            const activeBills = bills.filter(bill => (parseFloat(bill.totalAmount) - parseFloat(bill.paidAmount)) > 0.005);
            
            const deletedCount = bills.length - activeBills.length;

            if (deletedCount === 0) {
                alert("No Fully Paid Bills found to delete.");
                return;
            }

            saveBills(activeBills);
            
            calculateWeeklyEarnings();
            loadAllBills();
            document.getElementById('searchResultsBody').innerHTML = '';

            alert(`${deletedCount} Fully Paid Bills successfully deleted.`);
        }
        
        // 6. Clear ALL Data 
        function clearAllData() {
            if (confirm("WARNING! Are you sure you want to clear ALL data (All Bills and History) from Local Storage? This action cannot be undone.")) {
                localStorage.removeItem(STORAGE_KEY);
                calculateWeeklyEarnings();
                loadAllBills();
                document.getElementById('searchResultsBody').innerHTML = '';
                alert("All data successfully cleared.");
            }
        }
        
        // 7. Add Payment Function
        function addPayment(billId, totalAmount, currentPaidAmount) {
            const remainingBalance = (totalAmount - currentPaidAmount).toFixed(2);
            
            let inputAmount = prompt(`Total Amount: ${totalAmount.toFixed(2)}\nRemaining Balance: ${remainingBalance}\n\nEnter the amount received to ADD:`);

            if (inputAmount === null) {
                return; 
            }

            const amountToAdd = parseFloat(inputAmount);

            if (isNaN(amountToAdd) || amountToAdd <= 0) {
                alert('Invalid Amount. Please enter a correct value.');
                return;
            }
            
            const newTotalPaidAmount = currentPaidAmount + amountToAdd;
            
            if (newTotalPaidAmount > totalAmount) {
                 alert(`Error: Adding this payment exceeds the Total Bill Amount. (Max remaining: ${remainingBalance})`);
                 return;
            }

            let bills = getBills();
            const billIndex = bills.findIndex(b => b.id === billId);

            if (billIndex !== -1) {
                bills[billIndex].paidAmount = newTotalPaidAmount.toFixed(2); 
                
                if (!bills[billIndex].paymentHistory) {
                    bills[billIndex].paymentHistory = [];
                }
                
                bills[billIndex].paymentHistory.push({
                    date: new Date().toISOString().split('T')[0], // Today's date
                    amount: amountToAdd.toFixed(2)
                });
                
                saveBills(bills);
                
                calculateWeeklyEarnings();
                loadAllBills(); 
                
                document.getElementById('searchResultsBody').innerHTML = '';
                document.getElementById('searchQuery').value = '';
                
                alert(`Amount ${amountToAdd.toFixed(2)} added to bill ${bills[billIndex].refNumber}.\nNew Balance: ${(totalAmount - newTotalPaidAmount).toFixed(2)} PKR`);
            }
        }


        // 8. Weekly Earnings Calculation (MODIFIED)
        function calculateWeeklyEarnings(useManualDates = false) {
            const bills = getBills();
            let startDate;
            let endDate;

            if (useManualDates) {
                // Use manually entered dates
                const startInput = document.getElementById('startDateInput').value;
                const endInput = document.getElementById('endDateInput').value;

                if (!startInput || !endInput) {
                    alert("Please select both Start and End dates to apply the filter.");
                    return;
                }

                startDate = new Date(startInput);
                endDate = new Date(endInput);
                // Set end time to 23:59:59 to include the whole last day
                endDate.setHours(23, 59, 59, 999); 
            } else {
                // Default: Calculate the current calendar week
                const today = new Date();
                const dayOfWeek = (today.getDay() + 6) % 7; 
                
                startDate = new Date(today);
                startDate.setDate(today.getDate() - dayOfWeek);
                startDate.setHours(0, 0, 0, 0);

                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23, 59, 59, 999);
                
                // Also set the default values in the new input fields
                document.getElementById('startDateInput').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDateInput').value = endDate.toISOString().split('T')[0];
            }
            
            // Ensure Start Date is before End Date
            if (startDate > endDate) {
                alert("Error: Start Date cannot be after End Date.");
                return;
            }


            const startOfWeekStr = startDate.toISOString().split('T')[0];
            const endOfWeekStr = endDate.toISOString().split('T')[0];

            let totalEarnings = 0;

            bills.forEach(bill => {
                if (bill.paymentHistory) {
                    bill.paymentHistory.forEach(payment => {
                        const paymentDate = new Date(payment.date);
                        // The date check must be strict to include payments made on the boundaries
                        if (paymentDate >= startDate && paymentDate <= endDate) {
                            const paymentAmount = parseFloat(payment.amount);
                            totalEarnings += paymentAmount;
                        }
                    });
                }
            });

            document.getElementById('weekDates').textContent = `${startOfWeekStr} to ${endOfWeekStr}`;
            document.getElementById('totalWeeklyEarnings').textContent = totalEarnings.toFixed(2);
        }

        // 9. MODIFIED: Bill Submission Handler (Saves Bill Note)
        document.getElementById('billEntryForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const refNumber = document.getElementById('refNumber').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const billNote = document.getElementById('billNote').value.trim(); 
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const paidAmount = parseFloat(document.getElementById('paidAmount').value);
            const billDate = document.getElementById('billDate').value;

            let bills = getBills();
            const messageElement = document.getElementById('message');

            if (paidAmount > totalAmount) {
                 messageElement.textContent = 'Error: Paid Amount cannot be greater than Total Amount.';
                 messageElement.style.color = 'red';
                 return;
            }
            if (bills.some(bill => bill.refNumber === refNumber)) {
                messageElement.textContent = 'Error: This Reference Number is already in use.';
                messageElement.style.color = 'red';
                return;
            }
            
            const initialHistory = [];
            if (paidAmount > 0) {
                 initialHistory.push({
                    date: billDate,
                    amount: paidAmount.toFixed(2)
                });
            }


            const newBill = {
                id: Date.now(), 
                refNumber: refNumber,
                name: customerName,
                billNote: billNote, 
                totalAmount: totalAmount.toFixed(2), 
                paidAmount: paidAmount.toFixed(2), 
                date: billDate,
                paymentHistory: initialHistory 
            };

            bills.push(newBill);
            saveBills(bills);

            this.reset();
            document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
            messageElement.textContent = `Bill successfully saved. Ref No: ${refNumber}`;
            messageElement.style.color = 'green';
            
            calculateWeeklyEarnings();
            loadAllBills(); 
        });

        // 10. Search Functionality
        function performSearch() {
            const query = document.getElementById('searchQuery').value.toLowerCase().trim();
            const bills = getBills();
            
            if (query.length < 1) {
                document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="8" style="color: red;">Enter Ref Number or Name to search.</td></tr>';
                return;
            }

            const filteredBills = bills.filter(bill => 
                bill.refNumber.toLowerCase().includes(query) ||
                bill.name.toLowerCase().includes(query)
            );
            
            displayBills(filteredBills, 'searchResultsBody');
        }

        function loadAllBills() {
            const allBills = getBills();
            displayBills(allBills, 'allBillsBody');
        }


        // Initialize the app on page load
        window.onload = () => {
            document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
            // Initial call will set default dates (current week) and calculate earnings
            calculateWeeklyEarnings(); 
            loadAllBills(); 
        };

    </script>

</body>
</html>